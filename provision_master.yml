- name: Provision Master
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Include variables
      include_vars: all.yml
    - name: Launch configuration is present
      ec2_lc:
        name: KubeMaster {{ master_ami_id }}
        image_id: "{{ master_ami_id }}"
        instance_profile_name: KubeMaster
        instance_type: t2.micro
        key_name: "{{ ec2_keypair }}"
        region: "{{ vpc_region }}"
        assign_public_ip: yes
      register: lc_out
    - name: ASG is present
      ec2_asg:
        name: KubeMaster
        min_size: "{{ number_of_masters }}"
        max_size: "{{ number_of_masters }}"
        desired_capacity: "{{ number_of_masters }}"
        launch_config_name: "{{ lc_out.name }}"
        region: "{{ vpc_region }}"
        vpc_zone_identifier: "{{ vpc_subnets | map(attribute='id') | list }}"
        load_balancers:
          - etcd
          - kubernetes
        tags:
          - role: master
          - os: coreos
          - KubernetesCluster: "{{ kubernetes.name }}"
